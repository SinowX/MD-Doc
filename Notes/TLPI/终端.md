### 整体概览



- 传统终端与终端模拟器都需要同终端驱动程序相关联，由驱动程序负责处理设备上的输入和输出
- 当执行输入时，驱动程序的两种工作模式
  - 规范模式（默认输入模式）
    - 终端的输入按行来处理，而且 可进行 行编辑 操作
    - 每一行都由换行符来结束
    - 在终端上执行的 read() 调用只会在一行输入完成之后才会返回，且最多只会返回一行
    - 若 read() 请求的字节数少于当前行中的可用字节，则剩下的字节在下次 read() 调用时可用
  - 非规范模式
    - 终端输入不会装配成行
    - 如 vi、more、less 这样的程序会将终端置于非规范模式
    - 不需要用户按下回车键即可读取到单个的字符
- 终端驱动程序能对一系列特殊字符做解释，如中断字符（通常为 Ctrl+C）以及文件结尾符（通常为 Ctrl+D）
- 当有信号为前台进程组产生时，或是程序在终端读取时出现某种类型的输入条件，就可能出现这样的解释操作
- 非规范模式下的程序通常也会禁止处理某些或者所有这些特殊字符
- <img src="https://i.loli.net/2021/10/12/rZsETjpfblPx8MN.jpg" style="zoom: 25%;" />
- SUSv3 规定了
  -  MAX_INPUT 上限，可用来表示终端输入队列的最大长度
  - MAX_CANON 上限，处于规范模式下一行输入的最大字节数
  - sysconf(_SC_MAX_INPUT) 和 sysconf(_SC_MAX_CANON) 均返回 255
  - 但是内核只是简单地在i输入队列上加上了 4096字节的限制
  - 输出队列也有一个这样的限制，但程序不需要关心
    - 因为如果一个进程产生输出的速度比终端驱动程序的速度还要快的话，内核会暂停执行进程，直到输出队列的空间再次可用
- Linux 上 可调用 ioctl(fd, FIONREAD, &cnt) 来获取终端输入队列中为读取的字节数





### 获取、修改终端属性

- ```c
  #include<termios.h>
  
  int tcgetattr(int fd, struct termios *termios_p);
  int tcsetattr(int fd, int optional_actions, const struct termios *termios_p);
  ```

- 成功返回0，失败返回 -1

- fd 是指向终端的文件描述符

  - 若不指向终端会报错，错误码为 ENOTTY

- termios_p 是一个指向结构体 termios 的指针，用来记录终端的属性

  - ```c
    struct termios{
        tcflag_t c_iflag;
        tcflag_t c_oflag;
        tcflag_t c_cflag;
        tcflag_t c_lflag;
        cc_t c_line;
        cc_t c_cc[NCCS];
        speed_t c_ispeed;
        speed_t c_ospeed;
    }
    ```

  - | 掩码    | 说明                           |
    | ------- | ------------------------------ |
    | c_iflag | 控制终端输入的标志             |
    | c_oflag | 控制终端输出的标志             |
    | c_cflag | 与终端线速的硬件控制相关的标志 |
    | c_lflag | 控制终端输入的用户界面的标志   |

  - `c_line` 指定了终端的行规程（ line discipline ）

    - 为了达到对终端模拟器编程的目的，行规程将一直设为 N_TTY ，即 新规程
    - 这是内核中处理终端的代码的一个组件，实现了规范模式下的IO处理
    - 行规程的设定同串号编程有关

  - `c_cc` 包含着终端的特殊字符，中断、挂起等，以及控制非规范模式下输入操作的相关字段

    - 常数 NCCS 指定了数组中元素的个数

  - `c_ispeed` 和 `c_ospeed` 的字段在Linux中没有用到

  

#### tcsetattr()

- 参数 optional_actions 确定这些修改何时生效

- | 参数值    | 描述                                                         |
  | --------- | ------------------------------------------------------------ |
  | TCSANOW   | 立即生效                                                     |
  | TCSADRAIN | 当所有当前处于排队的输出已经传送到终端之后，修改得以生效     |
  | TCSAFLUSH | 与TCSADRAIN 相同，但是，当标志生效时那些仍在等待处理的输入数据都会被丢弃 |

- 常用做法

  - 调用 tcgetattr()  获取一个包含当前设定的 termios 结构体，然后调用 tcsetattr() 将更新后的结构体传回给驱动程序

  - 举例，将回显功能关闭

  - ```c
    struct termios tp;
    if( tcgetattr( STDIN_FILENO, &tp ) == -1 )
        errExit("tcgetattr");
    tp.c_lflag &= ~ECHO;
    if(tcsetattr( STDIN_FILENO, TCSAFLUSH, &tp ) == -1)
        errExit("tcsetattr");
    ```

- 对任何一个终端属性修改请求可以执行即返回成功

  - 为了保证修改成功，修改后需要再调用一次 tcgetattr() 获取终端属性



- 若 tcsetattr() 由后台进程组的一个进程调用，则终端驱动程序会发送 SIGTTOU 信号来暂停这个进程组
  - 因此，如果从孤儿进程组中调用，调用会失败，错误码 EIO
  - 同理，适用于 tcflush() tcflow() tcsendbreak() tcdrain()
- 本章描述的几个函数，如 tcgetattr() tcsetattr() ，都是在 POSIX 中创建的
  - Linux 的这些库函数，也是在 ioctl() 层之上



### stty 命令可以在终端 查看或修改 终端属性

- 



### 终端特殊字符

| 字符    | c_cc 下标 | 描述 | 默认设定 | 相关的位掩码标志 | SUSv3 |
| ------- | --------- | ---- | -------- | ---------------- | ----- |
| CR      |           |      |          |                  |       |
| DISCARD |           |      |          |                  |       |
| EOF     |           |      |          |                  |       |
| EOL     |           |      |          |                  |       |
| EOL2    |           |      |          |                  |       |
| ERASE   |           |      |          |                  |       |
| INTR    |           |      |          |                  |       |
| KILL    |           |      |          |                  |       |
| LNEXT   |           |      |          |                  |       |
| NL      |           |      |          |                  |       |
| QUIT    |           |      |          |                  |       |
| REPRINT |           |      |          |                  |       |
| START   |           |      |          |                  |       |
| STOP    |           |      |          |                  |       |
| SUSP    |           |      |          |                  |       |
| WERASE  |           |      |          |                  |       |



### 终端标志

- termios 结构体中 4 个标志字段所控制的设置
- 除了那些可指定掩码的值，表格中列出的常量都对应于单个比特位

#### c_iflag

| 字段    | 描述 | 默认 | SUSv3 |
| ------- | ---- | ---- | ----- |
| BRKINT  |      |      |       |
| ICRRNL  |      |      |       |
| IGNBRK  |      |      |       |
| IGNCR   |      |      |       |
| IGNPAR  |      |      |       |
| IMAXBEL |      |      |       |
| INLCR   |      |      |       |
| INPCK   |      |      |       |
| ISTRIP  |      |      |       |
| IUTF8   |      |      |       |
| IUCLC   |      |      |       |
| IXANY   |      |      |       |
| IXOFF   |      |      |       |
| IXON    |      |      |       |
| PARMRK  |      |      |       |



#### c_oflag

| 字段   | 描述 | 默认 | SUSv3 |
| ------ | ---- | ---- | ----- |
| BSDLY  |      |      |       |
| CRDLY  |      |      |       |
| FFDLY  |      |      |       |
| NLDLY  |      |      |       |
| OCRNL  |      |      |       |
| OFDEL  |      |      |       |
| OFILL  |      |      |       |
| OLCUC  |      |      |       |
| ONLCR  |      |      |       |
| ONLRET |      |      |       |
| ONOCR  |      |      |       |
| OPOST  |      |      |       |
| TABDLY |      |      |       |
| VTDLY  |      |      |       |

#### c_Cflag

| 字段    | 描述 | 默认 | SUSv3 |
| ------- | ---- | ---- | ----- |
| CBAUD   |      |      |       |
| CBAUDEX |      |      |       |
| CIBAUD  |      |      |       |
| CLOCAL  |      |      |       |
| CMSPAR  |      |      |       |
| CREAD   |      |      |       |
| CRTSCTS |      |      |       |
| CSIZE   |      |      |       |
| CSTOPB  |      |      |       |
| HUPCL   |      |      |       |
| PARENB  |      |      |       |
| PARODD  |      |      |       |



#### c_oflag

| 字段    | 描述 | 默认 | SUSv3 |
| ------- | ---- | ---- | ----- |
| ECHO    |      |      |       |
| ECHOCTL |      |      |       |
| ECHOE   |      |      |       |
| ECHOK   |      |      |       |
| ECHOKE  |      |      |       |
| ECHONL  |      |      |       |
| ECHOPRT |      |      |       |
| FLUSHO  |      |      |       |
| ICANON  |      |      |       |
| IEXTEN  |      |      |       |
| ISIG    |      |      |       |
| NOFLSH  |      |      |       |
| PENDIN  |      |      |       |
| TOSTOP  |      |      |       |
| XCASE   |      |      |       |

