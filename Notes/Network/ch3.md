## 数据链路层

- 链路（Link）就是从一个结点到相邻结点的一段物理线路，中间没有任何其他的交换结点
- 数据链路（Data Link）是指把实现通信协议的硬件和软件加到链路上，就构成了数据链路
- 数据链路层以帧为单位传输和处理数据

![image-20210818102833075](https://i.loli.net/2021/10/12/Rrq8LzFkcfAT3dt.png)

### 封装成帧

![image-20210818103712443](https://i.loli.net/2021/10/12/HqMCEzAr7PypniL.png)

- 点对点协议

<img src="https://i.loli.net/2021/10/12/kORyWKGA7qMjXwh.png" alt="image-20210818105000867" style="zoom:33%;" />

- 帧头和帧尾中包含由重要的控制信息
  - 帧定界——PPP帧的首位的两个1byte 标志字段(并不是每一种数据链路层协议都包含有帧定界标志)
  - 对于以太网V2的MAX帧，物理层会在其前增加 8bytes 前导码字段
    - <img src="https://i.loli.net/2021/10/12/WRTpJG2PjCw1rvS.png" alt="image-20210818105440567" style="zoom:33%;" />
    - 其中前同步码是使接收方的时钟同步
    - 以太网规定了帧间间隔时间为 96bits 的发送时间
- 透明传输
  - 是指数据链路层对上层交付的传输数据没有任何限制（帧的数据部分可能会包含伪帧定界），就好像数据链路层不存在
  - 面向字节的物理链路使用字节填充（字符填充）的方法实现透明传输
    - 增加转义字符ESC，其长度为一个字节 '27'
    - <img src="https://i.loli.net/2021/10/12/JYbh4lDH3RaQemK.png" alt="image-20210818110239189" style="zoom:33%;" />
    - <img src="/home/sinow/.config/Typora/typora-user-images/image-20210818110258294.png" alt="image-20210818110258294" style="zoom:33%;" />
  - 面向比特的物理链路使用比特填充的方法实现透明传输
    - <img src="https://i.loli.net/2021/10/12/HO3LzsAEIv7XKoi.png" alt="image-20210818110449969" style="zoom:33%;" />
    - 帧的数据部分没5个连续的比特1后边插入一个比特0
- 为了提高帧的传输效率，应当使帧的数据部分的长度尽可能大些
  - 考虑到差错控制等 多种因素，每一种数据链路层协议都规定了帧的数据部分的长度上限，即最大传送单元 MTU





### 差错检测

<img src="https://i.loli.net/2021/10/12/JnqyOU3j1xkvWXN.png" alt="image-20210818103808410" style="zoom:50%;" />

- 比特差错
  - 实际的通信链路不够理想，比特传输过程中可能会产生差错
- 误码率BER Bit Error
  - 在一段时间内，传输错误的比特占所传输比特总数的比率称为误码率
- 使用差错检测码来监测数据在传输过程中是否产生了比特差错，是数据链路层所要解决的重要问题之一
- <img src="https://i.loli.net/2021/10/12/TaGuKZJ63xHOnh8.png" alt="image-20210818112124736" style="zoom:50%;" />
- 奇偶校验
  - 在待发送的数据后面添加1位奇偶校验位，使得整个数据（包括所添加的校验位在内）中的 1 的个数为奇数或偶数
  - 容易产生漏检
- 循环冗余校验CRC Cyclic Redundancy Check
  - 收发双方约定好一个生成多项式G(x)
  - 发送放基于待发送的数据和生成多项式计算出差错检测码（冗余码），将其添加到带传输数据的后面一起传输
  - 接收方通过生成多项式来计算收到的数据是否产生了误码
  - <img src="https://i.loli.net/2021/10/12/jPzwDeQASunKhZg.png" alt="image-20210818112733986" style="zoom:33%;" />
  - ![image-20210818112848796](https://i.loli.net/2021/10/12/kl6Mq1eb2gUCz5Z.png)
  - 缺点
    - 检错码只能检测出帧在传输过程中出现了差错，但不能定位错误，因此无法纠正错误
    - 要纠正传输中的差错，可使用冗余信息更多的纠错码进行前向纠错，但纠错码的开销比较大，计算机网络中使用较少
  - CRC 漏检率非常低，易于用硬件实现，因而广泛应用于数据链路层
  - 计算机网络中通常采用检错重传方式来纠正传输中的差错，或者仅仅是丢弃检测到的差错的帧，这取决于数据链路层向上提供的时可靠传输服务还是不可靠传输服务

- 













### 可靠传输

- 尽管误码时不能完全避免的，但是如果可以实现发送方发送什么，接收方就能收到什么，就称为可靠传输

<img src="https://i.loli.net/2021/10/12/7XoL4nMC6UjTkaK.png" alt="image-20210818113510741" style="zoom: 33%;" />

- 比特差错只是传输差错中的一种，传输差错还包括分组丢失、分组失序、分组重复
- 分组丢失、分组失序、分组重复一般不会出现在数据链路层，而是出现在其上层
- 可靠传输服务并不仅局限于数据链路层，其他各层均可以实现可靠传输
- TCP 向其上层提供面向连接的可靠传输服务
- UDP 向其上层提供无连、不可靠传输服务
- IP 向其上层提供无连、不可靠传输服务
- 802.11 无线局域网要求数据链路层实现可靠传输
- 以太网不要求数据链路层实现可靠传输

#### 停止-等待协议 SW

![image-20210818175516091](https://i.loli.net/2021/10/12/e7wacPgILsiBEYu.png)

- 接收端检测到数据分组有误码时，将其丢弃并等待发送方的超时重传，但对于误码率较高的点对点链路，为使发送方尽早重传，也可给发送方发送 NAK 分组
- 为了让接收方能够判断收到的数据分组是否是重复的，需要给数据分组编号。由于停止-等待协议的停等特性，只需要一个bit编号就够了，即编号0和1
- 为了让发送方能够判断所收到的ACK分组是否是重复的，需要给ACK分组编号，所用比特数量与数据分组编号所用比特数量一样。数据链路层一般不会出现ACK分组迟到的情况，因此在数据链路层实现停止-等待协议可以不用给ACK分组编号
- 超时计时器设置的重传时间应该自习选择，一般可以将重传时间选为略大于“从发送方到接收方的平均往返时间”
  - 在数据链路层点对点的往返时间比较确定，重传时间比较好设定
  - 然而在传输层，由于端到端往返时间非常不确定，设置合适的重传时间有时并不容易

![image-20210820150858994](https://i.loli.net/2021/10/12/YrZfiOkunXyJMBp.png)

- 当往返时延RTT远大于数据帧发送时延TD 时，例如卫星链路，信道利用率非常低
- 若出现重传，则对于传送有用的数据信息来说，信道利用率还要降低



#### 回退N帧协议 GBN

- 采用$n$个比特给分组编序号
- 发送窗口的尺寸 $W_T$​的取值为 $1<W_T\le2^{n}-1$​（若  $W_T=1$​，则为停止等待协议，若$W_T > 2^n -1$​，则会导致序号紊乱）
- 接受窗口的尺寸 $W_R$ 取值为1

- 举例
  - 取n=3, WT = 5
  - 无差错情况
    - ![image-20210820153237201](https://i.loli.net/2021/10/12/PkjaWx52l4sigqV.png)
    - ![image-20210820153254160](https://i.loli.net/2021/10/12/TAxsXoi1ad765Lv.png)
    - ![image-20210820153312388](https://i.loli.net/2021/10/12/2d9OtuSXE3Ks4Um.png)
  - 有差错情况
    - ![image-20210820153552038](https://i.loli.net/2021/10/12/D9BiRj6nGm73dFl.png)
    - 差错检测有误码，丢弃之后，发现 `6701` 序号都不匹配，也将其丢弃，并对之前按序接收的最后一个数据进行确认，每丢弃一个数据分组，就发送一个ACK4
    - 发送方接收到重复的ACK，就知道之前所发送的数据分组出现了差错，于是可以不超时计时器超时，就立刻重传(具体看实现)
    - 尽管6701的数据正确到达接收方，但由于5号数据分组不被接受，发送放还要重传这些数据分组，所以叫做 回退N 协议
    - 当通信线路质量不好时，回退N协议的信道利用率并不比停止-等待协议高
- 累积确认
  - 接收方不一定要对收到的数据分组逐个发送确认，而是可以在收到几个数据分组之后，对按序到达的最后一个数据分组发送确认，ACKn 表示序号为n 以前的所有数据分组都已正确接收
  - 优点：减少接收方的开销、网络资源的占用
  - 缺点：不能向发送方及时反映出接收方已经正确接受的数据分组信息



#### 选择重传协议 SR

- 采用$n$个比特给分组编序号
- 发送窗口的尺寸 $W_T$​​的取值为 $1<W_T\le2^{n-1}$​​（若  $W_T=1$​​，则为停止等待协议，若$W_T > 2^{n-1}$​​，则会导致序号紊乱）
- 接受窗口的尺寸 $W_R$ 取值为1 (若 $W_{R}=1$ ，则与回退N 协议相同 )

- 为了进一步提高性能，可设法只重传出现误码的数据分组，因此，接受窗口的尺寸 $W_R$ 应该大于1，以便接收方先收下失序到达但无误码并且序号落在接受窗口的那些数据分组，等到所缺分组收齐后再一并递交上层
- SR 为了使发送方仅重传出现差错的分组，接收方不能再采用累积确认，而需要对每个正确接收到的数据进行逐一确认
- ![image-20210820155800690](https://i.loli.net/2021/10/12/K4cGsnveS1Mhm2H.png)
- ![image-20210820155822000](https://i.loli.net/2021/10/12/QkZC9rWfSnOdTxR.png)

- ![image-20210820155848604](https://i.loli.net/2021/10/12/McC9oF8WJ2kfaSw.png)
- 









### 广播信道数据链路层的其他问题

- 编址问题

  ![image-20210818104211427](https://i.loli.net/2021/10/12/GHc9zDYpoxwg7fv.png)

- 共享式局域网（一根总线）

  - 以太网的媒体结束控制协议——CSMA/CD，建波监听多点接入/碰撞问题
  - <img src="https://i.loli.net/2021/10/12/l71vDPcZWAg4iyI.png" alt="image-20210818104513481" style="zoom: 33%;" />
  - 

- 交换式局域网

  - 使用点对点链路或链路层交换机
  - 在有线局域网领域已完全取代了共享式局域网

- 无线局域网

  - 仍然使用共享信道技术
  - 802.11 局域网采用的媒体接入控制协议时 CSMA/CA，载波监听多点接入/碰撞避免
  - 



