# TCP 连接管理

- TCP 是一种面向连接的单播协议
- 通信双方必须在彼此间建立一条连接
- TCP服务模型是一个字节流



## TCP 连接的建立与终止

- 一个TCP连接由4元组构成，分别是两个IP地址和两个端口号
  - 也可以说是由一对端点或套接字构成，其中通信的每一端都由一对IP地址、端口号唯一标识
- 3个阶段：启动、数据传输（连接已建立）、退出（关闭）
- 建立过程
  1. 主动开启者，发送一个 SYN 报文段（一个在TCP头部的SYN位字段置位的 TCP/IP 数据包），并指明想要连接的端口号和主动开启者初始序列号（ ISN(c) ），通常还会发送一个或多个选项，主动发送的这个SYN报文段称作 段1
  2. 被动开启者，发送自己的SYN报文段作为响应，并包含了其初始序列号（ ISN(s) ），该段称为段2
     - 为了确认客户端的SYN，服务器将其包含的 ISN(c) 数值加1后作为返回的ACK数值
     - 如果出现失败的情况，该SYN段将会重传
  3. 为了确认服务器的SYN，客户端将ISN(s) 的数值加1后作为返回ACK数值。该段称为段3
- <img src="https://i.loli.net/2021/10/12/hs2L8X5IHRCVOlG.png" alt="image-20210903180837294" style="zoom:50%;" />
  - 三次握手利用数据包的选项来承载特殊的信息，交换初始化序列号 Initial Sequence Number, ISN
- 关闭过程
  1. 主动关闭者，发送一个FIN段，指明接收者希望看到自己当前的序列号(K)
     - FIN 段还包含了一个ACK段用于确认对方最近一次发来的数据
  2. 被动关闭者，将K的数值加1作为响应的ACK值，表明其已经成功接收到主动关闭者发送的FIN
     - 上层应用程序会被告知连接的另一端已经提出关闭的请求，一般会发起自己的关闭请求
     - 被动关闭者发送自己的FIN，该报文段的序列号为L
  3. 主动关闭者，发送一个包含ACK的报文段，用于确认上一个 FIN
     - 如果FIN丢失，被动关闭者将重新传输，直到接收到一个ACK确认



## TCP半关闭

- 伯克利套接字提供了半关闭操作，只需调用 shutdown() 来代替 close() 函数
- 过程
  - 主动关闭者发送FIN
  - 被动关闭者回应该FIN的ACK
  - 被动关闭者传输任意数量的数据段
  - 被动关闭者发送完后，发送一个FIN来关闭本方的连接，同时向发起半关闭的应用程序发送一个文件尾指示
  - 主动关闭者发送ACK确认后，整个连接完全关闭
- <img src="https://i.loli.net/2021/10/12/fLpzo25PU8tvkWJ.png" alt="image-20210903182505932" style="zoom:50%;" />



## 同时打开与关闭

#### 同时打开

- 主机A 中的APP通过 本地 7777 端口向 主机B 的 8888 端口发送一个主动打开请求
- 与此同时，主机B 中的一个APP也通过本地的 8888端口向主机A 的 7777 的端口提出一个主动打开的请求，此时就会发生一个同时打开的情况
- <img src="https://i.loli.net/2021/10/12/X8GJTsyBEDgdpjr.png" alt="image-20210903182933085" style="zoom:50%;" />

#### 同时关闭

- <img src="https://i.loli.net/2021/10/12/hcp1FaPsJXi5knw.png" alt="image-20210903183036055" style="zoom:50%;" />



## 初始序列号

- 当一个连接打开时，任何拥有合适的IP地址、端口号、符合逻辑的序列号以及正确校验和的报文段都会被对方接收
- 在发送用于建立连接的SYN 之前，通信双方会选择一个初始序列号
- 初始序列号会随着时间而改变，因此每一个连接都拥有不同的初始序列号
- [RFC0793] 指出初始序列号可以被视为一个32位的计数器
  - 该计数器每4ms 加 1
  - 目的是为一个连接的报文段安排序列号，以防止出现其他连接的序列号重叠的情况
  - 尤其是对于同一连接的两个不同实例而言，新的序列号也不能出现重叠的情况
- 一个TCP连接由四元组唯一标识，所以即便是同一个连接，也会出现不同的实例
  - 如果连接由于某个报文段的长时间延迟而被关闭，然后又以相同的四元组被重新打开，则延迟的报文段又会被视为有效数据重新接入新连接的数据流中
  - 通过一些方式来避免实例之间的序列号重叠问题，将风险降低
  - 也可以应用层利用CRC或校验和等，来避免出错

- Linux 初始序列号方案
  - 基于时钟方案，针对每一个连接，为时钟设置随机的偏移量
  - 随机偏移量是在连接标识（四元组）的基础上利用加密散列得到
  - 散列函数的输入每隔5min就会改变一次
  - 在32位的初始序列号中，最高8位是一个保密的序列号，而剩余的各位则由散列函数生成



### 连接与转换器

- 当一个TCP连接首次建立时，NAT能够根据报文段的SYN位来探明这一事实
- 也可以通过检查 SYN+ACK报文段 与 ACK 报文段所包含的序列号来判断一个连接是否已经完全建立
- 上述方法还适用于连接的终止
- 通过在NAT中实现一部分TCP 状态机，能够跟踪连接，包括当前状态、各方向的序列号以及相关的ACK号





## TCP 选项

| 种类 | 长度 | 名称           | 描述                         |
| ---- | ---- | -------------- | ---------------------------- |
| 0    | 1    | EOL            | 选项列表结束                 |
| 1    | 1    | NOP            | 无操作，用于填充             |
| 2    | 4    | MSS            | 最大段大小                   |
| 3    | 3    | WSOPT          | 窗口缩放因子，窗口左移量     |
| 4    | 2    | SACK-Permitted | 发送者支持SACK选项           |
| 5    | 可变 | SACK           | SACK阻塞，接收到乱序数据     |
| 8    | 10   | TSOPT          | 时间戳选项                   |
| 28   | 4    | UTO            | 用户超时，一段空闲时间后终止 |
| 29   | 可变 | TCP-AO         | 认证选项，使用多种算法       |
| 253  | 可变 | Experimental   | 保留                         |
| 254  | 可变 | Experimental   | 保留                         |

- 种类0或1的选项仅占用了一个字节，其他的选项会根据种类来确定自身的字节数len
- 选项的总长度包括了种类与len 个字节
- NOP
  - 允许发送者在必要的时候用多个4字节组填充某个字段
  - 因TCP头部的长度应该是32比特( 4 bytes )的倍数，因为TCP头部长度以此为单位
- EOL
  - 指出了选项列表的结尾，说明无需对选项列表再进行处理



### MSS

- 最大段大小指允许从对方接收到的最大的报文段，这也是通信双方在发送数据时能够使用的最大报文段
- MSS 只记录TCP数据的字节数，而不包括TCP、IP头部
- 建立TCP连接时，通信的每一方都要在SYN报文段的MSS选项中说明自己允许的最大段大小
- 这个16bit 选项能够说明最大段大小的数值
- 未指明的情况下，MSS 默认为536 bytes
  - 任何主机都应该能够处理至少576字节的IPv4 数据报
  - 按照最小的IPv4与TCP头部计算，MSS为536字节
    - 则 $576=20+20+536$
- IPv4中 MSS 典型值为 1460
  - 则IPv4数据报的大小也增加40（20+20），得到1500bytes，即以太网中最大传输单元与互联网路径最大传输单元的典型数值
- IPv6中 MSS 典型值为 1440
  - IPv6头部比IPv4 头部多20bytes，因而MSS 减小20bytes

- 65535 是一个特殊值，与IPv6超长数据报一起用来指定一个表示无限大的有效最大段大小值
  - 这种情况下，发送方的最大段大小等于路径MTU减去60bytes（40bytes for IPv6 header，20bytes for TCP header）

- MSS并不是TCP通信双方的协商结果，而是一个限定的数值
- 当通信的一方将自己的MSS发送给对方时，表明自己不愿意在整个连接过程中接收任何大于该尺寸的报文段



### 选择确认选项

- 由于采用累积ACK确认，TCP不能正确地确认之前已经接受的数据
  - 由于接受的数据是无需的，所以接收到的数据的序列号也不是连续的
  - 此时TCP接收方的数据队列会出现空洞的情况
- 如果发送方能够了解接收方当前的空洞，发送方就可以在报文段丢失或被接收方遗漏时更好地进行重传工作
- SACK提供了上述功能
  - 如果接收方能够提供选择确认信息，并且发送方能够合理有效利用这些信息，则上述方案会十分高效
- 通过接收SYN或SYN+ACK报文段中 SACK-Permitted 选项，TCP通信方会了解自己可以发布SACK信息
  - 当接收到乱序的数据时，它能够提供一个SACK选项来描述这些乱序的数据，从而帮助对方有效地进行重传
- SACK信息保存在SACK选项中
  - 包含接收方已经成功接收的数据块的序列号范围
  - 每一个范围被称作一个SACK块，由一对32位的序列号表示
  - 一个SACK选项包含了n个SACK块，长度为 (8n + 2) 个字节，增加的2个字节用于保存SACK选项与长度
- TCP头部选项空间有限，因而一个报文段中发送的最大SACK块数目为3（假设使用了时间戳选项）



### 窗口缩放选项 WSOPT WSCALE

- 能够将TCP 窗口广告 字段的范围从16位增加到30位
- TCP 头部不需要改变窗口字段的大小，仍然维持16位数值
- 同时，使用另一个选项作为16位数值的比例因子
- 该比例因子使窗口字段值左移，使窗口数值扩大到原先的$2^s$倍，其中s为比例因子
- 一个字节的移动可以用0到14来计数
  - 最大的比例数值14，提供一个最大为$65535 \times 2^{14}$  的窗口
  - 该数值接近$2^{30}-1$ 1GB
- 该选项只能出现在SYN报文段，当建立连接后，比例因子是与方向绑定的
- 为了保证窗口调整，通信双方都需要在SYN报文段包含该选项
  - 主动打开连接的一方利用自己的SYN中发送该选项
  - 被动打开的一方只能在接收到SYN中指出该选项时才能发送
- 每个方向的比例因子可以不同，
- 如果主动打开连接的一方发送了一个非0的比例因子缺没有收到来自对方的WSOPT ，则主动发送方将自己发送与接收的比例因子数值都设为0
- 举例
  - 发送出去的窗口移动数值为 S，收到的为 R
  - 则接收到的每一个16位广告窗口都需要左移R为才能获得真实的窗口大小
  - 每次向对方发送窗口通告时，都会将32位的窗口向右移动S位，然后将16位的数值填充到TCP头部？



### 时间戳选项 TSOPT

- TSOPT 要求发送方在每一个报文段添加2个4字节的时间戳数值
- 接收方将会在确认中反映这些数值，允许发送方针对每一个接收到的ACK（由于累积确认，所以不是每个报文段）估算TCP连接的往返时间

- 当使用时间戳选项时

  - 发送方将一个32位的数值填充到时间戳数值字段（TSV）作为时间戳选项的第一个部分
  - 接收方则接收到的时间戳数值原封不动地填充到第二部分时间戳回显重试字段 TSER
  - 由于包含时间戳选项，TCP头部的长度会增长10字节，8字节用于保存2个时间戳数值，2个字节用于指明选项的数值与长度


- 时间戳是一个单调增加的数值
  - 接受者只会对它接收到的信息做出相应，所以它并不关心时间戳单元或数值到底是什么
  - 该选项并不要求在两台主机之间进行任何形式的时钟同步
  - RFC1323  推荐发送者每秒钟至少将时间戳加1
- 估算一条TCP连接往返时间主要是为了设置重传超时

  - 重传超时用于告知TCP通信方何时应该重新发送可能已经丢失的报文段
  - 借助时间戳，可以获得往返时间相对精确的测量结果
  - 在使用时间戳选项之前，大多TCP通信会针对每个窗口的数据抽取一个往返时间样本，时间戳选项提供了更多样本，精确估算往返时间

### 防回绕序列号 PAWS


- <img src="https://i.loli.net/2021/10/12/GNwpiDvL718Iohx.png" alt="image-20210909084159323" style="zoom:50%;" />
- 假设一个TCP连接使用了窗口缩放选项，并将其设置为可能最大的窗口，大约1GB

  - 且使用了时间戳选项，发送者针对发送的每个窗口分配的时间戳数值都会加1（正常情况下时间戳数值的增长速度要远快于此）
- 上图显示了传输6GB数据时两主机之间的数据流
- 32位序列号字段在时刻D和时刻E间回绕
- 假设时刻B有一个报文段丢失并被重传

  - 假设该报文段在时刻F重新出现，且丢失与重新出现的时间差小于MSL
  - 旧的报文重新出现并包含当前正在传输的序列号的问题只会发生在相对高速的连接中
- 接收者可以将时间戳看作一个32 位的扩展序列号。丢失的报文段会在时刻F 重新出现, 由于它的时间戳为2 , 小于最近的有效时间戳( 5 或6 ) , 因此防回绕序列号算法会将其丢弃。
- 防回绕序列号算法并不要求在发送者与接收者之间有任何形式的时钟同步。接收者所需要的是保证时间戳数值单调增长，并且每个窗口的数据至少增加1



### 用户超时选项 UTO

- 用户超时数值USER_TIMEOUT指明了TCP发送者等待ACK的时间
  - USER_TIMEOUT 是TCP协议本地配置的一个参数
  - 用户超时选项允许将自己的USER_TIMEOUT 参数告知对方
    - 便于对方调整行为
    - NAT设备可以解释这些信息并设置其连接活动计时器
- UTO 的数值是建议性的
  - RFC1122建议
    - 当TCP连接达到3次重传阈值时应该通知应用程序
    - 当超时大于100s时应关闭连接
- 为了使UTO数值合理配置，有公式
  - $USER\_TIMEOUT = min(U\_LIMIT, max(ADV\_UTO, REMOTE\_UTO,L\_LIMIT))$
  - ADV_UTO是 本端告知对方的用户超时选项数值
  - REMOTE_UTO是 对方告知己方的用户超时选项数值
  - U_LIMIT是 本地系统对用户超时选项设定的数值上边界
  - L_LIMIT是 下边界（必须大于对应连接的重传超时数值，推荐100s）
- 建立连接的SYN 报文段、首个非SYN 报文段以及USER_TIMEOUT 的数值发生任何改变的报文段, 都会包含用户超时选项。该选项的数值由一个1 5 位的数值部分与一个1 位的单位部分构成。单位部分用于说明数值的计量单位是分钟(  1  ) 还是秒( 0 )。



### TCP 认证选项 TCP-AO

- TCP Authentication Option
- 该选项用于增强连接的安全性





## TCP 路径最大传输单元发现

- 路径最大传输单元 MTU

  - 经过两台主机之间路径的所有网络报文段中最大传输单元的最小值
  - 有助于避免分片

- TCP常规路径最大传输单元发现过程

  - 在建立一个连接时，TCP使用对外的最大传输单元的最小值，或根据通信双方声明的最大段大小来选择发送方的最大段大小 SMSS

  





