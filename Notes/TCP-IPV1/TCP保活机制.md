# TCP保活机制

- 如果TCP连接的双方都不向对方发送数据，则TCP连接的两端就不会有任何数据交换

- 理论上，中间路由器可以崩溃和重启，数据线可以断开再连接，只要两端主机没有重启或更改IP地址，它们会保持连接状态
- 注意
  - 上述假设只是在特定情况下发生的。
  - 首先, 客户端和服务器都没有实现应用层的非活动状态检测计时器, 该计时器超时会导致任何一个应用进程的终止。
  - 其次, 中间路由器不能保存连接的相关状态, 例如一个NAT 配置信息。某些特定操作中常常需要这些状态, 而它们也会由于非活动状态而删除, 或者由于系统故障而丢失。
  - 这些前提条件在现在的网络环境中是很难实现的。

- 一些情况下，客户端与服务器需要了解什么时候终止进程或与对方断开连接
- 另一些情况下，虽然APP之间没有任何数据交换，但仍然需要通过连接保持一个最小的数据流
- TCP保活机制就是为了解决上述两种情况而设计的
- 保活机制是一种在不影响数据流内容的情况下，探测对方的方式
  - 是由一个保活计时器实现的
  - 当计时器被激发，连接的一端将发送一个保活探测报文，另一端接收报文的同时会发送一个ACK作为相应



## 描述

- 保活机制默认情况下是关闭的
- TCP任一端都可请求打开这一功能
- 保活机制可被设置在一端或两端
- 如果在keepalive time 内连接处于非活动状态，开启保活功能的一端将向对方发送一个保活探测的报文
  - 如果发送端没有受到响应报文，那么经过一个 keepalive interval，发送端会继续发送保活探测报文，直到次数到达 keepalive probe
  - 这时，对方主机将被确认为不可到达，连接中断
- 保活探测报文为一个空报文段（或只包含一个字节）
- 序列号等于对方主机发送ACK报文的最大序列号减1
- 由于这一序列号已经被成功接收，所以不会对到达的报文段产生影响
- TCP保活功能在工作中，开启该功能的一端会发现对方处于以下四种状态之一
  - 对方仍在工作，并且可以到达
    - TCP相应正常，并且请求端也直到对方在正常工作
    - 请求段将保活计时器重置
    - 如果计时器超时之前有应用程序通过该连接传输数据，则计时器将再次被设定为保活时间值
  - 对方主机已崩溃，包括已关闭或正在重新启动
    - 对方TCP不响应，请求端不会接收到响应报文
  - 客户主机崩溃并且已重启
    - 请求段会受到一个对其保活探测报文的响应，但是一个重置报文段，请求将会断开连接
  - 对方主机仍在工作，但不能到达请求段
    - 与主机崩溃相同
- 相关变量在 `/proc/sys/net/ipv4` 中修改
- Linux 默认设置是 7200 秒、75秒、9次探测


