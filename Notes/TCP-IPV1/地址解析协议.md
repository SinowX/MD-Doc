# 地址解析协议

- 地址解析协议 ARP 提供了一种在IPv4地址和硬件地址之间的映射
- ARP 仅用于IPv4
- IPv6使用邻居发现协议，被合并入ICMPv6
- ARP是一个通用的协议，支持多种地址之间的映射，但是几乎总是应用于32位IPv4地址和48位MAC地址之间的映射



## 一个例子

- web浏览器打开 `http://10.0.0.1`

### 直接交付和ARP

1. app 调用函数解析 URL，检测是否包含主机名
   - 此处不包含
2. app 要求TCP建立一条到10.0.0.1的连接
3. 通过向 10.0.0.1发送一个IPv4数据报，TCP尝试与远程主机发送一个连接请求
4. 假设10.0.0.1与app主机使用相同的网络前缀，数据报可被直接发送到这个地址，而不经过任何路由器
5. 假设以太网兼容地址被用于IPv4子网，发送主机必须将32位的IPv4目的地址转换为48位的以太网地址
   - 即从逻辑Internet地址到对应的物理硬件地址进行转换
   - ARP工作在正常模式下，仅适用于广播网络，链路层能将一个消息交付到它连接的所有网络设备
   - 在非广播网络NBMA，可能需要更复杂的映射协议
6. 在一个共享的链路层网段上，ARP向所有主机发送一个称为ARP请求的以太网帧
   - 被称为链路层广播
7. 通过ARP，同一广播域中的所有系统可接收ARP请求
   - 着包括IPv4或IPv6的系统，但不包括不同VLAN中的系统
   - 如果某个系统使用请求中指出的IPv4地址，它仅需要相应一个ARP应答
   - 这个应答包含IPv4地址和对应的MAC地址
   - 这个应答通常是直接发送给请求的发送方
   - 接收到ARP请求的主机学习IPv4到MAC地址的映射
8. ARP应答被原始请求的发送方接收
9. 发送方可将数据报封装在以太网帧中直接发送到目的主机，并使用由ARP交换学到的以太网地址作为目的地址
   - 当仅使用直接交付时，并不需要经过路由器

- ARP用于运行IPv4的多接入链路层网络，每个主机都有自己首选的硬件地址
- 点到点链路如PPP不适用ARP
  - 当这些链路建立后，链路两端通知正在使用的地址
  - 由于不涉及硬件地址，所以不需要地址解析或ARP
- 以太网主机在同一广播域中，ARP查询使用链路层广播帧发送, 并被所有主机接收。IP地址匹配的主机直接向请求主机返回响应，IP地址不匹配的主机主动丢弃ARP查询



## ARP 缓存

- ARP缓存使用地址解析为每个接口维护从网络层地址到硬件地址的最新映射
- 当IPv4地址映射到硬件地址时，它对应于高速缓存中的一个条目，正常到期时间是条目创建开始后的20分钟
- Linux 中使用 `arp` `arp -a` 来查看arp缓存



## ARP帧格式

### 常用ARP请求和应答格式

<img src="https://i.loli.net/2021/10/12/3Bls4nTHvXEGmog.png" alt="image-20210905093007687" style="zoom:50%;" />

- 前14字节构成标准的以太网头部，假设没有802.1p/q 或其他标记，其余部分由ARP协议来定义
  - 前两个字段包含目的和源以太网地址
  - 对于ARP请求，目的以太网地址`ff:ff:ff:ff:ff:ff`是广播地址，在同一广播域中的所有以太网接口都可以接收这些帧
  - 对于ARP，2字节的长度或类型段必须是 `0x0806`
- ARP帧的前8个字节是通用的，上图的剩余部分专门用于将IPv4 地址映射到48位的以太网地址
  - 长度或类型字段后的4个字段指定了最后4个字段的类型和大小
  - 术语硬件和协议用于描述ARP分组中的字段，例如一个ARP请求询问协议地址（此处为IPv4）对应的硬件地址（此处的MAC）
  - 硬件类型字段指出硬件地址类型，对于以太网来说，该值为1
  - 协议类型字段指出映射的协议地址类型，对于IPv4地址来说，该值为`0x0800`
  - 当以太网帧包含IPv4数据报时，这可能与以太网帧的类型字段值一直
  - 硬件大小和协议大小分别指出硬件地址和协议地址的字节，对于以太网中使用的IPv4地址的ARP请求和应答，其值分别为 6和4
  - Op字段指出该操作是
    - 1 ARP请求
    - 2 ARP应答
    - 3 RARP请求
    - 4 RARP应答
  - 由于ARP请求和应答的长度或类型字段相同，所以Op字段是必须的
  - 后面的4个字段包含着一些重复信息
    - 以太网头部和ARP消息都包含发送方硬件地址
  - 对于一个ARP请求，除了目的硬件地址（设为0）之外，其他字段都需要填充
  - 当一个系统接收到一个ARP请求，它填充自己的硬件地址，将两个发送方地址和两个接收方地址互换，将Op字段设为2，然后发送生成的应答



